{%- comment -%} _layouts/bib_filter.html — title first, preview + badges side-by-side; preview click opens the preview itself; safe preview path building {%- endcomment -%}

{%- assign kw_raw   = entry.keywords   | default: '' -%}
{%- assign dir_raw  = entry.directions | default: '' -%}

{%- assign kw_list  = kw_raw  | split: ',' -%}
{%- assign dir_list = dir_raw | split: ',' -%}

{%- capture merged_dirs_str -%}{%- endcapture -%}
{%- for d in dir_list -%}
  {%- assign k = d | strip | downcase -%}
  {%- if k != '' -%}{%- capture merged_dirs_str -%}{{ merged_dirs_str }} {{ k }}{%- endcapture -%}{%- endif -%}
{%- endfor -%}
{%- for k in kw_list -%}
  {%- assign key = k | strip | downcase -%}
  {%- if key != '' and site.data.directions[key] -%}
    {%- capture merged_dirs_str -%}{{ merged_dirs_str }} {{ key }}{%- endcapture -%}
  {%- endif -%}
{%- endfor -%}
{%- assign merged_dirs_list = merged_dirs_str | strip | split: ' ' | uniq -%}

{%- assign sub_raw  = entry.keywords_sub | default: entry.subdirs | default: '' -%}
{%- assign sub_list_raw = sub_raw | split: ',' -%}

{%- capture other_kw_str -%}{%- endcapture -%}
{%- for k in kw_list -%}
  {%- assign key = k | strip | downcase -%}
  {%- if key != '' and site.data.directions[key] == nil -%}
    {%- capture other_kw_str -%}{{ other_kw_str }} {{ key }}{%- endcapture -%}
  {%- endif -%}
{%- endfor -%}
{%- assign other_kw_list = other_kw_str | strip | split: ' ' | uniq -%}

{%- assign proj_field = entry.project | default: '' -%}
{%- assign _parts = proj_field | split: ',' -%}
{%- assign proj_list = '' | split: '' -%}
{%- for _p in _parts -%}
  {%- assign t = _p | strip | downcase -%}
  {%- if t != '' -%}{%- assign proj_list = proj_list | push: t -%}{%- endif -%}
{%- endfor -%}
{%- assign proj_list = proj_list | uniq -%}

{%- assign doi   = entry.doi   | default: '' | strip -%}
{%- assign arxiv = entry.arxiv | default: '' | strip -%}

{%- assign thumb_href = nil -%}
{%- if entry.pdf -%}
  {%- if entry.pdf contains '://' -%}{%- assign thumb_href = entry.pdf -%}{%- else -%}{%- assign thumb_href = site.baseurl | append: '/assets/pdf/' | append: entry.pdf -%}{%- endif -%}
{%- elsif entry.html -%}
  {%- assign thumb_href = entry.html -%}
{%- elsif entry.website -%}
  {%- assign thumb_href = entry.website -%}
{%- elsif doi != '' -%}
  {%- assign thumb_href = 'https://doi.org/' | append: doi -%}
{%- elsif arxiv != '' -%}
  {%- assign thumb_href = 'https://arxiv.org/abs/' | append: arxiv -%}
{%- endif -%}

<div class="pub-entry"
     data-dirs="{{ merged_dirs_list | join: ' ' }}"
     data-projects="{{ proj_list | join: ' ' }}">

  <div class="pub-card">
    <div class="pub-body">
      <div class="pub-meta">
        {%- if entry.abbr -%}<span class="pub-venue">{{ entry.abbr }}</span>{%- endif -%}
      </div>

      <!-- Title first -->
      <div class="pub-title">{{ entry.title }}</div>

      <!-- Authors (self highlighted) -->
      <div class="pub-authors">
        {% for author in entry.author_array %}
          {%- assign author_is_self = false -%}
          {%- assign last = author.last  | remove: "¶" | remove: "&" | remove: "*" | remove: "†" | remove: "^" | strip -%}
          {%- assign first = author.first | strip -%}
          {%- if site.scholar.last_name contains last and site.scholar.first_name contains first -%}
            {%- assign author_is_self = true -%}
          {%- endif -%}
          {%- if forloop.first == false -%},&nbsp;{%- endif -%}
          {%- if author_is_self -%}
            <em>{{ author.first }} {{ author.last }}</em>
          {%- else -%}
            {{ author.first }} {{ author.last }}
          {%- endif -%}
        {% endfor %}
      </div>

      <!-- Side-by-side: preview thumbnail + impact badges -->
      <div class="pub-side">

        {%- comment -%} PREVIEW (always under /assets/img/publication_preview/) {%- endcomment -%}
        {%- if entry.preview -%}
          {%- assign preview_src = '/assets/img/publication_preview/' | append: entry.preview -%}
          <div class="pub-thumb">
            <a href="{{ preview_src }}" target="_blank" rel="noopener">
              <img src="{{ preview_src }}" alt="Preview of {{ entry.title }}" loading="lazy" decoding="async" class="preview-img">
            </a>
          </div>
        {%- endif -%}

        {%- comment -%} IMPACT BADGES (Dimensions / Altmetric) {%- endcomment -%}
        {%- if doi != '' or arxiv != '' -%}
          <div class="pub-impact">
            <div class="impact-badges">
              {%- if doi != '' -%}
                <span class="__dimensions_badge_embed__" data-doi="{{ doi }}" data-style="small_circle"></span>
              {%- endif -%}
              {%- if doi != '' -%}
                <span class="altmetric-embed" data-doi="{{ doi }}" data-badge-type="donut" data-hide-no-mentions="true"></span>
              {%- elsif arxiv != '' -%}
                <span class="altmetric-embed" data-arxiv-id="{{ arxiv }}" data-badge-type="donut" data-hide-no-mentions="true"></span>
              {%- endif -%}
            </div>
          </div>
        {%- endif -%}

      </div> <!-- /.pub-side -->

      {%- if merged_dirs_list.size > 0 or sub_list_raw.size > 0 or other_kw_list.size > 0 -%}
      <div class="dir-badges">
        {%- for key in merged_dirs_list -%}
          {%- assign info  = site.data.directions[key] -%}
          {%- assign clr   = info.color | default: '#444' -%}
          {%- assign label = info.label | default: key -%}
          <span class="dir-badge dir-{{ key }}" style="color: {{ clr }}; border-color: {{ clr }};">{{ label }}</span>
        {%- endfor -%}
        {%- for s in sub_list_raw -%}
          {%- assign skey = s | strip | downcase -%}
          {%- if skey != '' -%}
            {%- assign sinfo  = site.data.subdirections[skey] -%}
            {%- assign sclr   = sinfo.color | default: '#999' -%}
            {%- assign slabel = sinfo.label | default: skey -%}
            <span class="sub-badge sub-{{ skey }}" style="color: {{ sclr }}; border-color: {{ sclr }};">{{ slabel }}</span>
          {%- endif -%}
        {%- endfor -%}
        {%- for w in other_kw_list -%}
          {%- assign wkey = w | strip -%}
          {%- if wkey != '' -%}
            <span class="kw-badge kw-{{ wkey | replace: ' ', '-' }}" style="color: #000; border-color: #000;">{{ wkey }}</span>
          {%- endif -%}
        {%- endfor -%}
      </div>
      {%- endif -%}

      <div class="pub-links">
        {%- if entry.pdf -%}
          {%- if entry.pdf contains '://' -%}
            <a class="btn btn-sm" href="{{ entry.pdf }}" target="_blank" rel="noopener">PDF</a>
          {%- else -%}
            <a class="btn btn-sm" href="{{ site.baseurl }}/assets/pdf/{{ entry.pdf }}" target="_blank" rel="noopener">PDF</a>
          {%- endif -%}
        {%- endif -%}
        {%- if entry.arxiv -%}<a class="btn btn-sm" href="https://arxiv.org/abs/{{ entry.arxiv }}" target="_blank" rel="noopener">arXiv</a>{%- endif -%}
        {%- if entry.code -%}<a class="btn btn-sm" href="{{ entry.code }}" target="_blank" rel="noopener">Code</a>{%- endif -%}
        {%- if entry.website -%}<a class="btn btn-sm" href="{{ entry.website }}" target="_blank" rel="noopener">Website</a>{%- endif -%}
        {%- if entry.html -%}<a class="btn btn-sm" href="{{ entry.html }}" target="_blank" rel="noopener">HTML</a>{%- endif -%}
        {%- if entry.blog -%}<a class="btn btn-sm" href="{{ entry.blog | relative_url }}">Blog</a>{%- endif -%}
        {%- if entry.url -%}<a class="btn btn-sm" href="{{ entry.url }}" target="_blank" rel="noopener">Link</a>{%- endif -%}
        {%- if entry.bibtex_show -%}<a class="btn btn-sm" data-toggle="collapse" href="#bib-{{ entry.key }}">Bib</a>{%- endif -%}
      </div>

      {%- if entry.abstract -%}
      <details class="pub-abs"><summary>Abstract</summary><p>{{ entry.abstract }}</p></details>
      {%- endif -%}

      {%- if entry.bibtex_show -%}
      <div id="bib-{{ entry.key }}" class="pub-bib">
        <pre><code>{% raw %}{{ entry.bibtex }}{% endraw %}</code></pre>
      </div>
      {%- endif -%}
    </div> <!-- /.pub-body -->
  </div>   <!-- /.pub-card -->
</div>     <!-- /.pub-entry -->